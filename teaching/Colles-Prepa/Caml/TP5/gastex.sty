%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% GasTeX : Graphs and Automata Simplified in TeX
%%
%% Macros for drawing easily graphs and automata under the picture 
%% environment of LaTeX2e.
%% Documentation in gastex.doc 
%% See also the comments before the macros throughout the file.
%% Examples in ex_gastex.tex
%%
%% Paul Gastin
%% LIAFA
%% Universite Paris 7
%% 2, place Jussieu
%% F-75251 Paris Cedex 05
%% email : Paul.Gastin@liafa.jussieu.fr
%% www : http://www.liafa.jussieu.fr/~gastin
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% A lot of changes has been made since gastex 1.0 and as a result, 
% these new macros are no longer compatible with the previous ones.
% To be able to use old pictures, a compatible mode is provided
% (see \compatiblegastexun at the end of the file). The compatibility
% is almost 100% and should be sufficient in most cases.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% History since version 2.0
%  
% 2.01: 
% - Fix an error that occured in v2.0 when using Nfill=y without 
% defining previously fillgray or fillcolor.  
% The following default setting has been added.
% \gasset{fillgray=0,Nfill=n} % Not filled but black if filled
% 
% 2.1: 
% - New macros to draw directly circles, rectanges, ovals,
% lines and bezier curves. 
%   \drawcircle, \drawrect, \drawoval, 
%   \drawline, \drawqbezier, \drawcbezier
% All these macros uses gasset options and in particular: 
% Nframe, Nfill, linecolor, fillcolor, dash, AHnb, etc...
% - Compatibility mode for pspictpg up to v0.6
% - Fix the bug which occured sometimes when using Nw=0,Nh=0.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Known problems and (hopefully) solutions.
% 
% 21/10/99: Frank Goertzen (frank.goertzen@unibw-muenchen.de) has 
% reported that when using gastex together with german an error may 
% occur when running dvips if the german package is loaded first.  The 
% solution is to load gastex before german:
% \usepackage{gastex} 
% \usepackage{german} 
% I have no idea concerning the cause of this error.
% 
% 07/03/00: A postscript error may occur when using Nw=0,Nh=0.
% Solution: Use a small value instead of 0, e.g. Nw=0.1,Nh=0.1
% Fixed in version 2.1.
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{gastex}[2000/05/21 v2.1]
\RequirePackage{calc,trig}
\special{header=gastex.pro}
% \input gastex.ps

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Internal variables and macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcounter{cnt@a}\newcounter{cnt@b}\newcounter{cnt@c}
\newdimen\dim@x \newdimen\dim@y
\newbox\temp@box
\newdimen\d@my@unit \d@my@unit=0.01mm
% \d@my@unit is the unit used for all drawings with gastex.
% All values given in \unitlength are converted in \d@my@unit.
% The aim is to improve the precision of the drawings.

{\catcode`t=12\catcode`p=12\gdef\no@PT#1pt{#1}}
\def\strip@PT#1{\expandafter\no@PT\the#1\space}

\def\gas@initps{!BP
  \gas@dash
  \line@width setlinewidth 
  \line@color}

\def\gas@AHparam{\AH@nb\AH@d\AH@angle\AH@L\AH@l}
\def\gas@gobble#1{}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Settings
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------------
% Set values for gastex parameters.
% 
%   \gasset{parameter=value,parameter=value,...}
%   optional spaces are only allowed after commas
% 
% Nw=number
%   widht in \unitlength of oval nodes
% Nh=number
%   height in \unitlength of oval nodes
% Nmr=number
%   maximal radius in \unitlength of oval nodes
%   The actual radius will be min(Nw/2,Nh/2,Nmr)
%   Nmr=0 yields a rectangle node
%   
% Nadjust=any combination of the letters w,h,n
%   w : the node width is adjusted to the node label width + Nadjustdist
%   h : the node height is adjusted to the node label height + Nadjustdist
%   n : no adjustment
% Nadjustdist=number
%   distance in \unitlength between the label box and the node frame 
%   when using Nadjust
% 
% Nframe=y or n
%   boolean flag defining whether nodes are framed or not.
% Nfill=y or n
%   boolean flag defining whether nodes are filled or not.
%   Automatically set to true by the parameters fillgray and fillcolor
% 
% ExtNL=y or n
%   boolean flag defining whether node labels are external or not.
% NLangle=number
%   direction in degree of node labels
% NLdist=number
%   The meaning depends on the ExtNL flag.
%   If the flag is set to "n" then NLdist defines the distance
%   in \unitlength between the node center and the label center.
%   If the flag is set to "y" then NLdist defines the distance
%   in \unitlength between the node frame and the label box.
%   
% Nmarks=any combination of the letters i,f,r,n
%   i : initial mark on nodes
%   f : final mark on nodes
%   r : repeated mark on nodes
%   n : no mark on nodes
% ilength=number
%   length in \unitlength of arrows marking initial nodes
% iangle=number
%   direction in degree of arrows marking initial nodes
% flength=number
%   length in \unitlength of arrows marking final nodes
% fangle=number
%   direction in degree of arrows marking final nodes
% rdist=number
%   distance in \unitlength between the lines of repeated nodes
%   a positive value draw the second line inside the normal one
%   a negative value draw the second line outside the normal one 
%   but the edges are still connected to the normal line.
%   
% loopdiam=number
%   diameters in \unitlength of loops
% loopangle=number
%   direction in degree of loops
% curvedepth=number
%   depth in \unitlength of curved edges between two nodes
%   The absolute value of curvedepth defines the distance between the
%   middle of the curved edge and the center of the line joining the two nodes 
%   With a positive/negative value the curved edge is on the left/right
%   of the line joining the two nodes.
%
% AHnb=number
%   number of arrowhead(s) at the end of edges.
%   0 for no arrowhead.
% AHdist=number
%   distance in \unitlength between two arrowheads
% AHangle=angle
%   angle in degree between the edge and the arrowhead side
% AHLength=number
%   Length in \unitlegth of the arrowhead side
% AHlength=number
%   length in \unitlegth defining the shape of the arrowhead
%     0 for an arrowhead formed with just two lines
%     Length*cos(angle) for a triangular arrowhead
%     See examples.
% 
% ELside=l or r
%   label on the (l)eft or (r)ight side of the edge
% ELpos=0..100
%   position of the label along the edge.
%     0 : starting node
%    50 : middle of the edge
%   100 : ending node
% ELdist=number
%   distance in \unitlength between the label and the edge
%   
% linegray=decimal number between 0 and 1
%   gray level used to draw lines. 0=black, 1=white.
% fillgray=decimal number between 0 and 1
%   gray level used to fill nodes. 0=black, 1=white.
% linecolor=ColorName
%   color used to draw lines.
%   The color name should be defined in dvipsnam.def and one should 
%   include \usepackage[usenames]{color}.
%   This is to avoid the trouble of defining our own colors.
%   The drawback is that it is not possible to define and use other colors.
%   It should not be very restrictive since plenty of colours are 
%   defined in dvipsnam.def.
%   It should not be difficult to add the possibility of using new 
%   colors if needed. 
% fillcolor=ColorName
%   color used to fill nodes. See remarks above.
% linewidth=number
%   width in \unitlegth of lines
% dash={list of numbers}{offset}
%   Set the dash pattern used for drawing postscript paths.
%   The numbers in the list indicate alternatively lengths
%   in \unitlength of dashes and lengths in \unitlength of spaces. 
%   The list of lenghts is used circularly.
%   offset allows to start the pattern at some distance from its beginning.
%   Here are some examples:
%      dash={}{0} % continuous path
%      dash={1.5}0 % dashs of length 1.5 and empty spaces of length 1.5
%      dash={0.2 0.5}0 % looks like a sequence of dots
%      dash={4 1 1 1}0 % alternation of long and short dashs
%      dash={1.5}{1.5} % we start with the empty space and not the dash
%      dash={4}{2} % we start in the middle of the first dash
\def\gasset#1{\gas@set#1,&}%
\def\gas@set#1=#2,{\ignorespaces%
  \@ifundefined{gasset@#1}
    {\typeout{GasTeX warning: parameter #1 undefined.}}
    {\csname gasset@#1\endcsname{#2}}
  \@ifnextchar&{\gas@gobble}{\gas@set}}

\def\gasset@Nw#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\N@w{\thecnt@a}}%
\def\gasset@Nh#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\N@h{\thecnt@a}}%
\def\gasset@Nmr#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\N@mr{\thecnt@a}}%

\newif\if@wadjust \newif\if@hadjust \newif\if@nadjust
\def\gasset@Nadjust#1{%
  \@wadjustfalse \@hadjustfalse \gasset@@Nadjust #1&}
\def\gasset@@Nadjust#1{%
  \@ifundefined{if@#1adjust}
    {\typeout{GasTeX warning: Node adjust #1 undefined.}}
    {\csname @#1adjusttrue\endcsname}
  \@ifnextchar&{\gas@gobble}{\gasset@@Nadjust}}
\def\gasset@Nadjustdist#1{%
  \setcounter{cnt@a}{2*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\N@adjustdist{\thecnt@a}}%

\newif\if@frame \newif\if@fill \newif\if@ExtNL
\def\flag@y{\relax}\def\flag@n{\relax}
\def\gasset@Nframe#1{%
  \@ifundefined{flag@#1}
  {\typeout{GasTeX warning: Nframe value should be y or n.}}
  {\if#1y \@frametrue \else \@framefalse \fi}}
\def\gasset@Nfill#1{%
  \@ifundefined{flag@#1}
  {\typeout{GasTeX warning: Nfill value should be y or n.}}
  {\if#1y \@filltrue \else \@fillfalse \fi}}
\def\gasset@ExtNL#1{%
  \@ifundefined{flag@#1}
  {\typeout{GasTeX warning: ExtNL value should be y or n.}}
  {\if#1y \@ExtNLtrue \else \@ExtNLfalse \fi}}

\def\gasset@NLangle#1{\edef\NL@angle{#1}}%
\def\gasset@NLdist#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\NL@dist{\thecnt@a}}%

\newif\if@imark \newif\if@fmark \newif\if@rmark \newif\if@nmark
\def\gasset@Nmarks#1{%
  \@imarkfalse \@fmarkfalse \@rmarkfalse \gasset@@Nmarks #1&}
\def\gasset@@Nmarks#1{%
  \@ifundefined{if@#1mark}
    {\typeout{GasTeX warning: Node mark #1 undefined.}}
    {\csname @#1marktrue\endcsname}
  \@ifnextchar&{\gas@gobble}{\gasset@@Nmarks}}

\def\gasset@ilength#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\i@length{\thecnt@a}}%
\def\gasset@iangle#1{\edef\i@angle{#1}}%
\def\gasset@flength#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\f@length{\thecnt@a}}%
\def\gasset@fangle#1{\edef\f@angle{#1}}%
\def\gasset@rdist#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\rep@dist{\thecnt@a}}%

\def\gasset@loopdiam#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\loop@diam{\thecnt@a}}%
\def\gasset@loopangle#1{\edef\loop@angle{#1}}%
\def\gasset@curvedepth#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\curve@depth{\thecnt@a}}%

\def\gasset@AHnb#1{\edef\AH@nb{#1\space}}%
\def\gasset@AHdist#1{%
  \dim@x=#1\unitlength \edef\AH@d{\strip@PT\dim@x}}%
\def\gasset@AHangle#1{\edef\AH@angle{#1\space}}%
\def\gasset@AHLength#1{%
  \dim@x=#1\unitlength \edef\AH@L{\strip@PT\dim@x}}%
\def\gasset@AHlength#1{%
  \dim@x=#1\unitlength \edef\AH@l{\strip@PT\dim@x}}%

\def\ELside@l{\relax}\def\ELside@r{\relax}
\def\gasset@ELside#1{%
  \@ifundefined{ELside@#1}
  {\typeout{GasTeX warning: ELside value should be l or r.}}
  {\edef\EL@s{#1}}}%
\def\gasset@ELpos#1{
  \ifnum#1>100
    \typeout{GasTeX warning: ELpos value should be between 0 and 100}
  \else\ifnum#1<0
    \typeout{GasTeX warning: ELpos value should be between 0 and 100}
  \else\edef\EL@p{#1}\fi\fi}%
\def\gasset@ELdist#1{%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#1}}
  \edef\EL@dist{\thecnt@a}}%

\def\gasset@linegray#1{\edef\line@color{#1 setgray\space}}%
\def\gasset@linecolor#1{%
  \@ifundefined{\string\color @#1}
  {\typeout{GasTeX warning: color #1 undefined.}}
  {\edef\line@color{#1\space}}}%
\def\gasset@fillgray#1{\@filltrue\edef\fill@color{#1 setgray\space}}%
\def\gasset@fillcolor#1{%
  \@ifundefined{\string\color @#1}
  {\typeout{GasTeX warning: color #1 undefined.}}
  {\@filltrue\edef\fill@color{#1\space}}}%

\def\gasset@linewidth#1{%
  \dim@x=#1\unitlength \edef\line@width{\strip@PT\dim@x}}%
\def\gasset@dash#1{\gasset@@dash #1}%
\def\gasset@@dash#1#2{%
  \def\gas@dash{[}%
  \gas@convert 0 #1 &
  \dim@x=#2\unitlength
  \edef\gas@dash{\gas@dash] \strip@PT\dim@x setdash\space}}%
\def\gas@convert#1 {%
  \dim@x=#1\unitlength
  \ifdim\dim@x=0pt\else\edef\gas@dash{\gas@dash\strip@PT\dim@x}\fi%
  \@ifnextchar&{\gas@gobble}{\gas@convert}}

%-----------------------------------------------------------------------
% Default settings
\unitlength=1mm
\gasset{Nw=8,Nh=8,Nmr=4} % circle
\gasset{Nframe=y}
\gasset{fillgray=0,Nfill=n} % Not filled but black if filled
\gasset{ExtNL=n,NLangle=90,NLdist=0}
\gasset{iangle=180,ilength=5}
\gasset{fangle=0,flength=5}
\gasset{rdist=0.7}
\gasset{Nmarks=n} % no mark
\gasset{Nadjustdist=1,Nadjust=n} % no adjust
\gasset{loopdiam=8,loopangle=90}
\gasset{curvedepth=0}
% One triangular small arrowhead
\gasset{AHnb=1,AHdist=1.41,AHangle=20,AHLength=1.5,AHlength=1.41} 
\gasset{ELside=l,ELpos=50,ELdist=1}
\gasset{linegray=0} % black lines
\gasset{linewidth=0.14,dash={}0} % continuous path

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Nodes
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------------
% Define and draw a node.
% 
%   \node(NodeName)(x,y){NodeLabel}
%   \node[parameter=value,...](NodeName)(x,y){NodeLabel}
%  
% Required arguments: 
%   NodeName : name of the node
%   (x,y) : coordinates of the node in \unitlengh.
%   NodeLabel : label of the node. Empty if no label.
% Optional argument:
%   [parameter=value,...]
% One may just define a node without drawing it using an empty label 
% and the parameters Nframe=n,Nfill=n
\def\node#1(#2)(#3,#4)#5{{%
  \@ifnextchar[{\process@nodeopt}{\i@node}#1(#2)(#3,#4){#5}}}
\def\process@nodeopt[#1]{\gas@set#1,&\i@node}%
\def\i@node(#1)(#2,#3)#4{%
  \let@node(#1)(#2,#3){#4}\draw@node(#1){#4}}

%-----------------------------------------------------------------------
% Define a node without drawing it. Internal macro.
% 
%   \let@node(NodeName)(x,y){NodeLabel}
%  
% Required arguments: 
%   NodeName : name of the node
%   x,y : coordinates of the node in \unitlengh.
%   NodeLabel : label of the node. Empty if no label.
\def\let@node(#1)(#2,#3)#4{{%
% width and height of the box containing #4  
  \setbox\temp@box\hbox{#4}
  \if@wadjust
    \setcounter{cnt@a}{\N@adjustdist + \wd\temp@box / \d@my@unit}
    \edef\N@w{\thecnt@a}%
  \fi
  \if@hadjust
    \setcounter{cnt@a}{\N@adjustdist + (\ht\temp@box+\dp\temp@box) / \d@my@unit}
    \edef\N@h{\thecnt@a}%
  \fi
  \global\expandafter\edef\csname node@#1@w\endcsname{\N@w}%
  \global\expandafter\edef\csname node@#1@h\endcsname{\N@h}%
  \ifnum\N@h<\N@w
	\setcounter{cnt@a}{\N@h/2}
  \else
	\setcounter{cnt@a}{\N@w/2}
  \fi
  \ifnum\N@mr<\thecnt@a\setcounter{cnt@a}{\N@mr}\fi
  \global\expandafter\edef\csname node@#1@r\endcsname{\thecnt@a}%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#2}}
  \global\expandafter\edef\csname node@#1@x\endcsname{\thecnt@a}%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#3}}
  \global\expandafter\edef\csname node@#1@y\endcsname{\thecnt@a}%
}}

%-----------------------------------------------------------------------
% Draw a node which is already defined. Internal macro.
% 
%   \draw@node(NodeName){NodeLabel}
%  
% Required arguments: 
%   NodeName : name of the node
%   NodeLabel : label of the node. Empty if no label.
\def\draw@node(#1)#2{{%
  \unitlength=\d@my@unit
  \edef\cs@x{\csname node@#1@x\endcsname}%
  \edef\cs@y{\csname node@#1@y\endcsname}%
  \edef\cs@w{\csname node@#1@w\endcsname}%
  \edef\cs@h{\csname node@#1@h\endcsname}%
  \edef\cs@r{\csname node@#1@r\endcsname}%
  \dim@x=\cs@w\unitlength \edef\ps@w{\strip@PT\dim@x}%
  \dim@x=\cs@h\unitlength \edef\ps@h{\strip@PT\dim@x}%
  \dim@x=\cs@r\unitlength \edef\ps@r{\strip@PT\dim@x}%
  \put(\cs@x,\cs@y){\special{" \gas@initps 
    \if@fill 
	  \fill@color
      0 0 \ps@w \ps@h \ps@r !psovalpath fill 
	\fi
    \if@frame 
      \line@color
      0 0 \ps@w \ps@h \ps@r !psovalpath stroke
	\fi
  }}
  \if@imark \imark(#1) \fi
  \if@fmark \fmark(#1) \fi
  \if@rmark \rmark(#1) \fi
  \nodelabel(#1){#2}
}}

%-----------------------------------------------------------------------
% Add an ingoing arrow to mark an initial node.
% This arrow is usually drawn by \node using Nmarks=i.
% This separate macro can be used to draw several arrows
% or arrows with different colors, thickness, dash, ...
% 
%   \imark(NodeName)
%   \imark[parameter=value,...](NodeName)
%  
% Required arguments: 
%   NodeName : name of the node
% Optional argument:
%   [parameter=value,...]
\def\imark#1(#2){{%
  \@ifnextchar[{\process@imarkopt}{\i@mark}#1(#2)}}
\def\process@imarkopt[#1]{\gas@set#1,&\i@mark}%
\def\i@mark(#1){{%
  \unitlength=\d@my@unit
  \edef\cs@x{\csname node@#1@x\endcsname}%
  \edef\cs@y{\csname node@#1@y\endcsname}%
  \node@diam(#1,\i@angle)
  \setcounter{cnt@b}{\cs@nd/2}
  \setcounter{cnt@a}{\cs@x+(\thecnt@b+\i@length)*\real{\cs@cos}}
  \edef\cs@xa{\thecnt@a}%
  \setcounter{cnt@a}{\cs@y+(\thecnt@b+\i@length)*\real{\cs@sin}}
  \edef\cs@ya{\thecnt@a}%
  \dim@x=-\cs@cos\unitlength \multiply\dim@x by \i@length
  \dim@y=-\cs@sin\unitlength \multiply\dim@y by \i@length
  \put(\cs@xa,\cs@ya){\special{" \gas@initps
    \gas@AHparam \strip@PT\dim@x \strip@PT\dim@y !psvect}}
}}

%-----------------------------------------------------------------------
% Add an outgoing arrow to mark a final node.
% This arrow is usually drawn by \node using Nmarks=f.
% This separate macro can be used to draw several arrows
% or arrows with different colors, thickness, dash, ...
% 
%   \fmark(NodeName)
%   \fmark[parameter=value,...](NodeName)
%  
% Required arguments: 
%   NodeName : name of the node
% Optional argument:
%   [parameter=value,...]
\def\fmark#1(#2){{%
  \@ifnextchar[{\process@fmarkopt}{\f@mark}#1(#2)}}
\def\process@fmarkopt[#1]{\gas@set#1,&\f@mark}%
\def\f@mark(#1){{%
  \unitlength=\d@my@unit
  \edef\cs@x{\csname node@#1@x\endcsname}%
  \edef\cs@y{\csname node@#1@y\endcsname}%
  \node@diam(#1,\f@angle)
  \setcounter{cnt@b}{\cs@nd/2}
  \setcounter{cnt@a}{\cs@x+\thecnt@b*\real{\cs@cos}}
  \edef\cs@xa{\thecnt@a}%
  \setcounter{cnt@a}{\cs@y+\thecnt@b*\real{\cs@sin}}
  \edef\cs@ya{\thecnt@a}%
  \dim@x=\cs@cos\unitlength \multiply\dim@x by \f@length
  \dim@y=\cs@sin\unitlength \multiply\dim@y by \f@length
  \put(\cs@xa,\cs@ya){\special{" \gas@initps
    \gas@AHparam \strip@PT\dim@x \strip@PT\dim@y !psvect}}
}}

%-----------------------------------------------------------------------
% Add a second line to mark a repeated node.
% This line is usually drawn by \node using Nmarks=r.
% This separate macro can be used to draw several lines around the 
% node or lines with different colors, thickness, dash, ...
% 
%   \rmark(NodeName)
%   \rmark[parameter=value,...](NodeName)
%  
% Required arguments: 
%   NodeName : name of the node
% Optional argument:
%   [parameter=value,...]
\def\rmark#1(#2){{%
  \@ifnextchar[{\process@rmarkopt}{\r@mark}#1(#2)}}
\def\process@rmarkopt[#1]{\gas@set#1,&\r@mark}%
\def\r@mark(#1){{%
  \unitlength=\d@my@unit
  \edef\cs@x{\csname node@#1@x\endcsname}%
  \edef\cs@y{\csname node@#1@y\endcsname}%
  \edef\cs@w{\csname node@#1@w\endcsname}%
  \edef\cs@h{\csname node@#1@h\endcsname}%
  \edef\cs@r{\csname node@#1@r\endcsname}%
  \dim@y=-\rep@dist\unitlength
  \dim@x=\cs@w\unitlength \advance\dim@x\dim@y\advance\dim@x\dim@y
  \edef\ps@w{\strip@PT\dim@x}%
  \dim@x=\cs@h\unitlength \advance\dim@x\dim@y\advance\dim@x\dim@y
  \edef\ps@h{\strip@PT\dim@x}%
  \dim@x=\cs@r\unitlength \advance\dim@x\dim@y
  \ifnum\dim@x<0 \dim@x=0pt \fi
  \edef\ps@r{\strip@PT\dim@x}%
  \put(\cs@x,\cs@y){\special{" \gas@initps
    0 0 \ps@w \ps@h \ps@r !psovalpath stroke}}
}}

%-----------------------------------------------------------------------
% Add a label to the node.
% The position of the label is determined by the ExtNL flag
% and the parameters NLangle and NLdist.
% The label is usually drawn by \node.
% This separate macro can be used to add several labels
% 
%   \nodelabel(NodeName){NodeLabel}
%   \nodelabel[parameter=value,...](NodeName){NodeLabel}
%  
% Required arguments: 
%   NodeName : name of the node
%   NodeLabel : label of the node.
% Optional argument:
%   [parameter=value,...]
\newif\if@cosneg \newif\if@sinneg
\def\nodelabel#1(#2)#3{{%
  \@ifnextchar[{\process@nodelabelopt}{\node@label}#1(#2){#3}}}
\def\process@nodelabelopt[#1]{\gas@set#1,&\node@label}%
\def\node@label(#1)#2{{%
  \unitlength=\d@my@unit
  \edef\cs@x{\csname node@#1@x\endcsname}%
  \edef\cs@y{\csname node@#1@y\endcsname}%
  \if@ExtNL
    \node@diam(#1,\NL@angle)
    \setcounter{cnt@a}{\cs@nd/2}\edef\cs@nr{\thecnt@a}%
% width and height of the box containing #2  
    \setbox\temp@box\hbox{#2}
    \setcounter{cnt@a}{\wd\temp@box / \d@my@unit}
    \edef\cs@bw{\thecnt@a}%
    \setcounter{cnt@a}{(\ht\temp@box+\dp\temp@box) / \d@my@unit}
    \edef\cs@bh{\thecnt@a}%
%   
    \@cosnegfalse \@sinnegfalse
    \dim@x=\cs@cos pt \ifnum \dim@x<0 \@cosnegtrue \dim@x=-\dim@x \fi
    \edef\cs@abscos{\strip@PT\dim@x}%
    \dim@x=\cs@sin pt \ifnum \dim@x<0 \@sinnegtrue \dim@x=-\dim@x \fi
    \edef\cs@abssin{\strip@PT\dim@x}%
%   
    \setcounter{cnt@a}{((\cs@h+\cs@bh)/2+\NL@dist)*\real{\cs@abscos}}
    \setcounter{cnt@b}{((\cs@w+\cs@bw)/2-\cs@r)*\real{\cs@abssin}}
    \ifnum\thecnt@a<\thecnt@b
      \setcounter{cnt@c}{(\cs@h+\cs@bh)/2+\NL@dist}
  	  \if@sinneg \setcounter{cnt@c}{-\thecnt@c} \fi
      \setcounter{cnt@a}{\cs@x+\thecnt@c*\real{\cs@cos}/\real{\cs@sin}}
      \setcounter{cnt@b}{\cs@y+\thecnt@c}
      \put(\thecnt@a,\thecnt@b){\makebox(0,0){#2}}
    \else
      \setcounter{cnt@a}{((\cs@w+\cs@bw)/2+\NL@dist)*\real{\cs@abssin}}
      \setcounter{cnt@b}{((\cs@h+\cs@bh)/2-\cs@r)*\real{\cs@abscos}}
      \ifnum\thecnt@a<\thecnt@b
        \setcounter{cnt@c}{(\cs@w+\cs@bw)/2+\NL@dist}
        \if@cosneg \setcounter{cnt@c}{-\thecnt@c} \fi
        \setcounter{cnt@a}{\cs@x+\thecnt@c}
        \setcounter{cnt@b}{\cs@y+\thecnt@c*\real{\cs@sin}/\real{\cs@cos}}
        \put(\thecnt@a,\thecnt@b){\makebox(0,0){#2}}
      \else
% auxiliary parameters
        \setcounter{cnt@a}{\cs@r-(\cs@w+\cs@bw)/2}
        \edef\cs@xx{\thecnt@a}%
        \setcounter{cnt@a}{\cs@r-(\cs@h+\cs@bh)/2}
        \edef\cs@yy{\thecnt@a}%
        \setcounter{cnt@a}{(\cs@r+\NL@dist)*(\cs@r+\NL@dist)}
        \edef\cs@lim{\thecnt@a}%
        \def\cs@tmin{0}%
        \setcounter{cnt@a}{\NL@dist+(\cs@bw+\cs@bh)/2}
        \edef\cs@tmax{\thecnt@a}%
% computation of the center of the label
        \setcounter{cnt@c}{10}
        \@whilenum\thecnt@c>0\do{
          \setcounter{cnt@a}{(\cs@tmin+\cs@tmax)/2}
      	  \edef\cs@t{\thecnt@a}%
          \setcounter{cnt@a}{(\cs@nr+\cs@t)*\real{\cs@abscos}+\cs@xx}
          \setcounter{cnt@b}{(\cs@nr+\cs@t)*\real{\cs@abssin}+\cs@yy}
          \setcounter{cnt@a}{\thecnt@a*\thecnt@a + \thecnt@b*\thecnt@b}
		  \ifnum\thecnt@a<\cs@lim 
		    \edef\cs@tmin{\cs@t}%
		  \else 
		    \edef\cs@tmax{\cs@t}%
		  \fi
      	  \addtocounter{cnt@c}{-1}}
        \setcounter{cnt@a}{\cs@x+(\cs@nr+\cs@t)*\real{\cs@cos}}
        \setcounter{cnt@b}{\cs@y+(\cs@nr+\cs@t)*\real{\cs@sin}}
        \put(\thecnt@a,\thecnt@b){\makebox(0,0){#2}}
  	  \fi
    \fi
  \else % regular node label
    \CalculateCos{\NL@angle} \edef\cs@cos{\UseCos{\NL@angle}}%
    \CalculateSin{\NL@angle} \edef\cs@sin{\UseSin{\NL@angle}}%
    \setcounter{cnt@a}{\cs@x+\NL@dist*\real{\cs@cos}}
    \setcounter{cnt@b}{\cs@y+\NL@dist*\real{\cs@sin}}
    \put(\thecnt@a,\thecnt@b){\makebox(0,0){#2}}
  \fi
}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Edges
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------------
% Edge between two nodes.
% 
%   \drawedge(startingNode,endingNode){label}
%   \drawedge[parameter=value,...](startingNode,endingNode){label}
%  
% Required arguments: 
%   startingNode : name of the starting node,
%   endingNode : name of the ending node,
%   label : label of the edge. {} for no label.
% Optional argument:
%   [parameter=value,...]
\def\drawedge#1(#2)#3{{%
  \@ifnextchar[{\process@edgeopt}{\draw@edge}#1(#2){#3}}}
\def\process@edgeopt[#1]{\gas@set#1,&\draw@edge}%
\def\draw@edge(#1,#2)#3{%
% Control points of the cubic Bezier curve
  \edef\cs@xa{\csname node@#1@x\endcsname}%
  \edef\cs@ya{\csname node@#1@y\endcsname}%
  \edef\cs@xd{\csname node@#2@x\endcsname}%
  \edef\cs@yd{\csname node@#2@y\endcsname}%
  \setcounter{cnt@a}{\cs@xd-\cs@xa}
  \setcounter{cnt@b}{\cs@yd-\cs@ya}
  \setcounter{cnt@c}{\thecnt@a*\thecnt@a+\thecnt@b*\thecnt@b}
  \gas@sqrt{\thecnt@c}
  \setcounter{cnt@b}{\cs@xa+\cs@xd-4*\curve@depth*(\cs@yd-\cs@ya)/\the@sqrt}
  \setcounter{cnt@a}{(\thecnt@b+\cs@xa)/3}\edef\cs@xb{\thecnt@a}%
  \setcounter{cnt@a}{(\thecnt@b+\cs@xd)/3}\edef\cs@xc{\thecnt@a}%
  \setcounter{cnt@b}{\cs@ya+\cs@yd+4*\curve@depth*(\cs@xd-\cs@xa)/\the@sqrt}
  \setcounter{cnt@a}{(\thecnt@b+\cs@ya)/3}\edef\cs@yb{\thecnt@a}%
  \setcounter{cnt@a}{(\thecnt@b+\cs@yd)/3}\edef\cs@yc{\thecnt@a}%
  \unitlength=\d@my@unit
  \draw@b@edge(#1,#2){#3}
}

%-----------------------------------------------------------------------
% Edge between two nodes following a quadratic Bezier curve.
% The first and last control points are the centers of the starting 
% and ending nodes resp.
% The middle control point is given by its absolute cartesian coordinates
% 
%   \drawqbedge(startingNode,x,y,endingNode){label}
%   \drawqbedge[parameter=value,...](startingNode,x,y,endingNode){label}
%  
% Required arguments: 
%   startingNode : name of the starting node,
%   x,y : coordinates in \unitlength of the intermediary control point
%   endingNode : name of the ending node,
%   label : label of the edge. {} for no label.
% Optional argument:
%   [parameter=value,...]
\def\drawqbedge#1(#2)#3{{%
  \@ifnextchar[{\process@qbedgeopt}{\draw@qbedge}#1(#2){#3}}}
\def\process@qbedgeopt[#1]{\gas@set#1,&\draw@qbedge}%
\def\draw@qbedge(#1,#2,#3,#4)#5{%
% Control points of the cubic Bezier curve
  \edef\cs@xa{\csname node@#1@x\endcsname}%
  \edef\cs@ya{\csname node@#1@y\endcsname}%
  \edef\cs@xd{\csname node@#4@x\endcsname}%
  \edef\cs@yd{\csname node@#4@y\endcsname}%
  \setcounter{cnt@b}{2*\ratio{\unitlength}{\d@my@unit}*\real{#2}}
  \setcounter{cnt@a}{(\cs@xa+\thecnt@b)/3}\edef\cs@xb{\thecnt@a}%
  \setcounter{cnt@a}{(\cs@xd+\thecnt@b)/3}\edef\cs@xc{\thecnt@a}%
  \setcounter{cnt@b}{2*\ratio{\unitlength}{\d@my@unit}*\real{#3}}
  \setcounter{cnt@a}{(\cs@ya+\thecnt@b)/3}\edef\cs@yb{\thecnt@a}%
  \setcounter{cnt@a}{(\cs@yd+\thecnt@b)/3}\edef\cs@yc{\thecnt@a}%
  \unitlength=\d@my@unit
  \draw@b@edge(#1,#4){#5}
}

%-----------------------------------------------------------------------
% Edge between two nodes following a cubic Bezier curve.
% The first and last control points are the centers of the starting 
% and ending nodes resp.
% The second and third control points are given by their polar coordinates
% relative to the centers of the starting and ending nodes resp.
% 
%   \drawbpedge(startingNode,sa,sr,endingNode,ea,er){label}
%   \drawbpedge[parameter=value,...](startingNode,sa,sr,endingNode,ea,er){label}
%  
% Required arguments: 
%   startingNode : name of the starting node,
%   sa,sr : polar coordinates of the second control point relative to the center
%           of the starting node (angle in degree and radius in \unitlength)
%   endingNode : name of the ending node,
%   ea,er : polar coordinates of the third control point relative to the center
%           of the ending node (angle in degree and radius in \unitlength)
%   label : label of the edge. {} for no label.
% Optional argument:
%   [parameter=value,...]
\def\drawbpedge#1(#2)#3{{%
  \@ifnextchar[{\process@bpedgeopt}{\draw@bpedge}#1(#2){#3}}}
\def\process@bpedgeopt[#1]{\gas@set#1,&\draw@bpedge}%
\def\draw@bpedge(#1,#2,#3,#4,#5,#6)#7{%
% Control points of the cubic Bezier curve
  \edef\cs@xa{\csname node@#1@x\endcsname}%
  \edef\cs@ya{\csname node@#1@y\endcsname}%
  \edef\cs@xd{\csname node@#4@x\endcsname}%
  \edef\cs@yd{\csname node@#4@y\endcsname}%
  \setcounter{cnt@b}{1*\ratio{\unitlength}{\d@my@unit}*\real{#3}}
  \edef\cs@angle{#2}%
  \CalculateCos\cs@angle \CalculateSin\cs@angle
  \setcounter{cnt@a}{\cs@xa+\thecnt@b*\real{\UseCos\cs@angle}}
  \edef\cs@xb{\thecnt@a}%
  \setcounter{cnt@a}{\cs@ya+\thecnt@b*\real{\UseSin\cs@angle}}
  \edef\cs@yb{\thecnt@a}%
  \setcounter{cnt@b}{1*\ratio{\unitlength}{\d@my@unit}*\real{#6}}
  \edef\cs@angle{#5}%
  \CalculateCos\cs@angle \CalculateSin\cs@angle
  \setcounter{cnt@a}{\cs@xd+\thecnt@b*\real{\UseCos\cs@angle}}
  \edef\cs@xc{\thecnt@a}%
  \setcounter{cnt@a}{\cs@yd+\thecnt@b*\real{\UseSin\cs@angle}}
  \edef\cs@yc{\thecnt@a}%
  \unitlength=\d@my@unit
  \draw@b@edge(#1,#4){#7}
}

%-----------------------------------------------------------------------
% Edge between two nodes following a cubic Bezier curve.
% The first and last control points are the centers of the starting 
% and ending nodes resp.
% The second and third control points are given by their absolute 
% cartesian coordinates.
% 
%   \drawbcedge(startingNode,xs,ys,endingNode,xe,ye){label}
%   \drawbcedge[parameter=value,...](startingNode,xs,ys,endingNode,xe,ye){label}
%  
% Required arguments: 
%   startingNode : name of the starting node,
%   xs,ys : coordinates in \unitlength of the control point defining 
%           the tangent at the starting node
%   endingNode : name of the ending node,
%   xe,ye : coordinates in \unitlength of the control point defining
%           the tangent at the ending node
%   label : label of the edge. {} for no label.
% Optional argument:
%   [parameter=value,...]
\def\drawbcedge#1(#2)#3{{%
  \@ifnextchar[{\process@bcedgeopt}{\draw@bcedge}#1(#2){#3}}}
\def\process@bcedgeopt[#1]{\gas@set#1,&\draw@bcedge}%
\def\draw@bcedge(#1,#2,#3,#4,#5,#6)#7{%
% Control points of the cubic Bezier curve
  \edef\cs@xa{\csname node@#1@x\endcsname}%
  \edef\cs@ya{\csname node@#1@y\endcsname}%
  \edef\cs@xd{\csname node@#4@x\endcsname}%
  \edef\cs@yd{\csname node@#4@y\endcsname}%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#2}}
  \edef\cs@xb{\thecnt@a}%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#3}}
  \edef\cs@yb{\thecnt@a}%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#5}}
  \edef\cs@xc{\thecnt@a}%
  \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{#6}}
  \edef\cs@yc{\thecnt@a}%
  \unitlength=\d@my@unit
  \draw@b@edge(#1,#4){#7}
}

%-----------------------------------------------------------------------
% Loop on a node following a cubic Bezier curve.
% 
%   \drawloop(Node){label}
%   \drawloop[parameter=value,...](Node){label}
%  
% Required arguments: 
%   Node : name of the node,
%   label : label of the edge. {} for no label.
% Optional argument:
%   [parameter=value,...]
\def\drawloop#1(#2)#3{{%
  \@ifnextchar[{\process@loopopt}{\draw@loop}#1(#2){#3}}}
\def\process@loopopt[#1]{\gas@set#1,&\draw@loop}%
\def\draw@loop(#1)#2{%
% Control points of the cubic Bezier curve
  \unitlength=\d@my@unit
  \edef\cs@xa{\csname node@#1@x\endcsname}%
  \edef\cs@ya{\csname node@#1@y\endcsname}%
  \edef\cs@xd{\cs@xa}%
  \edef\cs@yd{\cs@ya}%
  \node@diam(#1,\loop@angle)
  \setcounter{cnt@a}{2*(\cs@nd+2*\loop@diam)/3}
  \setcounter{cnt@b}{\loop@diam*1732/1000} % approx of sqrt(3)
% Rotation
  \setcounter{cnt@c}
    {\cs@xa+\thecnt@a*\real{\cs@cos}-\thecnt@b*\real{\cs@sin}}
  \edef\cs@xb{\thecnt@c}%
  \setcounter{cnt@c}
    {\cs@xa+\thecnt@a*\real{\cs@cos}+\thecnt@b*\real{\cs@sin}}
  \edef\cs@xc{\thecnt@c}%
  \setcounter{cnt@c}
    {\cs@ya+\thecnt@a*\real{\cs@sin}+\thecnt@b*\real{\cs@cos}}
  \edef\cs@yb{\thecnt@c}%
  \setcounter{cnt@c}
    {\cs@ya+\thecnt@a*\real{\cs@sin}-\thecnt@b*\real{\cs@cos}}
  \edef\cs@yc{\thecnt@c}%
  \draw@b@edge(#1,#1){#2}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Other macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------------
% Draw a circle.
% 
%   \drawcircle(x,y,r)
%   \drawcircle[parameter=value,...](x,y,d)
%  
% Required arguments in \unitlengh: 
%   x,y : coordinates of the circle center.
%   d : diameter of the circle.
% Optional argument:
%   [parameter=value,...]
\def\drawcircle#1(#2){{%
  \@ifnextchar[{\process@circleopt}{\draw@circle}#1(#2)}}
\def\process@circleopt[#1]{\gas@set#1,&\draw@circle}%
\def\draw@circle(#1,#2,#3){{%
  \dim@x=#1\unitlength \edef\ps@x{\strip@PT\dim@x}%
  \dim@x=#2\unitlength \edef\ps@y{\strip@PT\dim@x}%
  \dim@x=#3\unitlength \edef\ps@d{\strip@PT\dim@x}%
  \put(0,0){\special{" \gas@initps 
    \if@fill 
	  \fill@color
      \ps@x \ps@y \ps@d 2 div !pscirclepath fill 
	\fi
    \if@frame 
      \line@color
      \ps@x \ps@y \ps@d 2 div !pscirclepath stroke
	\fi
  }}
}}

%-----------------------------------------------------------------------
% Draw a rectangle.
% 
%   \drawrect(x0,y0,x1,y1)
%   \drawrect[parameter=value,...](x0,y0,x1,y1)
%  
% Required arguments in \unitlengh: 
%   x0,y0 : coordinates of the lower left corner of the rectangle.
%   x1,y1 : coordinates of the upper right corner of the rectangle.
% Optional argument:
%   [parameter=value,...]
\def\drawrect#1(#2){{%
  \@ifnextchar[{\process@rectopt}{\draw@rect}#1(#2)}}
\def\process@rectopt[#1]{\gas@set#1,&\draw@rect}%
\def\draw@rect(#1,#2,#3,#4){{%
  \dim@x=#1\unitlength \edef\ps@x{\strip@PT\dim@x}%
  \dim@x=#2\unitlength \edef\ps@y{\strip@PT\dim@x}%
  \dim@x=#3\unitlength \edef\ps@a{\strip@PT\dim@x}%
  \dim@x=#4\unitlength \edef\ps@b{\strip@PT\dim@x}%
  \put(0,0){\special{" \gas@initps 
    \if@fill 
	  \fill@color
      \ps@x \ps@y \ps@a \ps@b !psrectpath fill 
	\fi
    \if@frame 
      \line@color
      \ps@x \ps@y \ps@a \ps@b !psrectpath stroke
	\fi
  }}
}}

%-----------------------------------------------------------------------
% Draw an oval.
% 
%   \drawoval(x,y,w,h,mr)
%   \drawoval[parameter=value,...](x,y,w,h,mr)
%  
% Required arguments in \unitlengh: 
%   x,y : coordinates of the oval center.
%   w,h : width and height of the oval.
%   rm : defines the maximal radius for the corners.
% Optional argument:
%   [parameter=value,...]
\def\drawoval#1(#2){{%
  \@ifnextchar[{\process@ovalopt}{\draw@oval}#1(#2)}}
\def\process@ovalopt[#1]{\gas@set#1,&\draw@oval}%
\def\draw@oval(#1,#2,#3,#4,#5){{%
  \dim@x=#1\unitlength \edef\ps@x{\strip@PT\dim@x}%
  \dim@x=#2\unitlength \edef\ps@y{\strip@PT\dim@x}%
  \dim@x=#3\unitlength \edef\ps@w{\strip@PT\dim@x}%
  \dim@x=#4\unitlength \edef\ps@h{\strip@PT\dim@x}%
  \dim@x=#5\unitlength \edef\ps@mr{\strip@PT\dim@x}%
  \put(0,0){\special{" \gas@initps 
    \if@fill 
	  \fill@color
      \ps@x \ps@y \ps@w \ps@h \ps@mr !psovalpath fill 
	\fi
    \if@frame 
      \line@color
      \ps@x \ps@y \ps@w \ps@h \ps@mr !psovalpath stroke
	\fi
  }}
}}

%-----------------------------------------------------------------------
% Draw a straight line.
% The line may have arrowhead(s), ... depending of the current settings
% 
%   \drawline(x0,y0,x1,y1)
%   \drawline[parameter=value,...](x0,y0,x1,y1)
%  
% Required arguments: 
%   x0,y0,x1,y1 : coordinates in \unitlength of the extremities of the line
% Optional argument:
%   [parameter=value,...]
\def\drawline#1(#2){{%
  \@ifnextchar[{\process@drawlineopt}{\draw@line}#1(#2)}}
\def\process@drawlineopt[#1]{\gas@set#1,&\draw@line}%
\def\draw@line(#1,#2,#3,#4){{%
  \dim@x=#3\unitlength \advance\dim@x by -#1\unitlength
  \dim@y=#4\unitlength \advance\dim@y by -#2\unitlength
  \put(#1,#2){\special{" \gas@initps
    \gas@AHparam \strip@PT\dim@x \strip@PT\dim@y !psvect}}
}}

%-----------------------------------------------------------------------
% Draw a quadratic Bezier curve.
% The line may have arrowhead(s), ... depending of the current settings
% 
%   \drawqbezier(x0,y0,x1,y1,x2,y2)
%   \gasline[parameter=value,...](x0,y0,x1,y1,x2,y2)
%  
% \drawqbezier arguments: 
%   x0,y0,x1,y1,x2,y2 : coordinates in \unitlength of the control points
% Optional argument:
%   [parameter=value,...]
\def\drawqbezier#1(#2){{%
  \@ifnextchar[{\process@drawqbezieropt}{\draw@q@bezier}#1(#2)}}
\def\process@drawqbezieropt[#1]{\gas@set#1,&\draw@q@bezier}%
\def\draw@q@bezier(#1,#2,#3,#4,#5,#6){{%
  \dim@x=#1\unitlength \edef\ps@xa{\strip@PT\dim@x}%
  \dim@x=#2\unitlength \edef\ps@ya{\strip@PT\dim@x}%
  \dim@x=#3\unitlength \edef\ps@xb{\strip@PT\dim@x}%
  \dim@x=#4\unitlength \edef\ps@yb{\strip@PT\dim@x}%
  \dim@x=#5\unitlength \edef\ps@xc{\strip@PT\dim@x}%
  \dim@x=#6\unitlength \edef\ps@yc{\strip@PT\dim@x}%
  \put(0,0){\special{" \gas@initps
    \gas@AHparam 
	\ps@xa \ps@ya \ps@xb \ps@yb \ps@xc \ps@yc !ps_qbezier}}
}}

%-----------------------------------------------------------------------
% Draw a cubic Bezier curve.
% The line may have arrowhead(s), ... depending of the current settings
% 
%   \drawcbezier(x0,y0,x1,y1,x2,y2,x3,y3)
%   \gasline[parameter=value,...](x0,y0,x1,y1,x2,y2,x3,y3)
%  
% \drawcbezier arguments: 
%   x0,y0,x1,y1,x2,y2,x3,y3 : coordinates in \unitlength of the control points
% Optional argument:
%   [parameter=value,...]
\def\drawcbezier#1(#2){{%
  \@ifnextchar[{\process@drawcbezieropt}{\draw@c@bezier}#1(#2)}}
\def\process@drawcbezieropt[#1]{\gas@set#1,&\draw@c@bezier}%
\def\draw@c@bezier(#1,#2,#3,#4,#5,#6,#7,#8){{%
  \dim@x=#1\unitlength \edef\ps@xa{\strip@PT\dim@x}%
  \dim@x=#2\unitlength \edef\ps@ya{\strip@PT\dim@x}%
  \dim@x=#3\unitlength \edef\ps@xb{\strip@PT\dim@x}%
  \dim@x=#4\unitlength \edef\ps@yb{\strip@PT\dim@x}%
  \dim@x=#5\unitlength \edef\ps@xc{\strip@PT\dim@x}%
  \dim@x=#6\unitlength \edef\ps@yc{\strip@PT\dim@x}%
  \dim@x=#7\unitlength \edef\ps@xd{\strip@PT\dim@x}%
  \dim@x=#8\unitlength \edef\ps@yd{\strip@PT\dim@x}%
  \put(0,0){\special{" \gas@initps
    \gas@AHparam 
	\ps@xa \ps@ya \ps@xb \ps@yb \ps@xc \ps@yc \ps@xd \ps@yd !ps_cbezier}}
}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Internal macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%-----------------------------------------------------------------------
% Compute the diameter of a node in some direction
% 
%   \node@diam(Node,angle)
%   
% Result in \cs@nd.
% Byproduct: \cs@cos=cos(angle), \cs@sin=sin(angle) are also defined.
% 
% There are 3 cases depending on whether the direction intersects the node
% on a vertical line, an horizontal line or a rounded corner.
\def\node@diam(#1,#2){%
  \edef\cs@w{\csname node@#1@w\endcsname}%
  \edef\cs@h{\csname node@#1@h\endcsname}%
  \edef\cs@r{\csname node@#1@r\endcsname}%
  \CalculateCos{#2} \edef\cs@cos{\UseCos{#2}}%
  \CalculateSin{#2} \edef\cs@sin{\UseSin{#2}}%
  \setcounter{cnt@a}{\cs@r+\cs@r}\edef\cs@rr{\thecnt@a}%
  \setcounter{cnt@a}{(\cs@h-\cs@rr)*\real{\cs@cos}}
  \ifnum\thecnt@a<0\edef\cs@A{-\thecnt@a}\else\edef\cs@A{\thecnt@a}\fi%
  \setcounter{cnt@a}{(\cs@w-\cs@rr)*\real{\cs@sin}}
  \ifnum\thecnt@a<0\edef\cs@B{-\thecnt@a}\else\edef\cs@B{\thecnt@a}\fi%
  \setcounter{cnt@a}{\cs@w*\real{\cs@sin}}
  \ifnum\thecnt@a<0\setcounter{cnt@a}{-\thecnt@a}\fi
  \ifnum\thecnt@a<\cs@A
    \setcounter{cnt@c}{\cs@w/\real{\cs@cos}}
    \ifnum\thecnt@c<0\edef\cs@nd{-\thecnt@c}\else\edef\cs@nd{\thecnt@c}\fi%
  \else
    \setcounter{cnt@a}{\cs@h*\real{\cs@cos}}
    \ifnum\thecnt@a<0\setcounter{cnt@a}{-\thecnt@a}\fi
    \ifnum\thecnt@a<\cs@B
      \setcounter{cnt@c}{\cs@h/\real{\cs@sin}}
      \ifnum\thecnt@c<0\edef\cs@nd{-\thecnt@c}\else\edef\cs@nd{\thecnt@c}\fi%
	\else
	  \setcounter{cnt@a}{\cs@rr*\cs@rr-(\cs@B-\cs@A)*(\cs@B-\cs@A)}
      \gas@sqrt{\thecnt@a}
      \setcounter{cnt@a}{(\cs@w-\cs@rr)*\real{\cs@cos}}
	  \ifnum\thecnt@a<0\edef\cs@E{-\thecnt@a}\else\edef\cs@E{\thecnt@a}\fi%
      \setcounter{cnt@a}{(\cs@h-\cs@rr)*\real{\cs@sin}}
	  \ifnum\thecnt@a<0\edef\cs@F{-\thecnt@a}\else\edef\cs@F{\thecnt@a}\fi%
      \setcounter{cnt@a}{\the@sqrt+\cs@E+\cs@F}\edef\cs@nd{\thecnt@a}%
	\fi
  \fi
%   \typeout{w=\cs@w,h=\cs@h,r=\cs@r,angle=#2,\cs@nd}
}  

%-----------------------------------------------------------------------
% Draw the cubic Bezier curve.
% The control points
% (\cs@xa,\cs@ya)(\cs@xb,\cs@yb)(\cs@xc,\cs@yc)(\cs@xd,\cs@yd)
% should already be defined.
% 
% #1 : name of the starting node
% #2 : name of the ending node
% #3 : label of the edge
\def\draw@b@edge(#1,#2)#3{{%
% Parameters for the Bézier curve.
  \dim@x=\cs@xa\unitlength \edef\ps@xa{\strip@PT\dim@x}%
  \dim@x=\cs@ya\unitlength \edef\ps@ya{\strip@PT\dim@x}%
  \dim@x=\cs@xb\unitlength \edef\ps@xb{\strip@PT\dim@x}%
  \dim@x=\cs@yb\unitlength \edef\ps@yb{\strip@PT\dim@x}%
  \dim@x=\cs@xc\unitlength \edef\ps@xc{\strip@PT\dim@x}%
  \dim@x=\cs@yc\unitlength \edef\ps@yc{\strip@PT\dim@x}%
  \dim@x=\cs@xd\unitlength \edef\ps@xd{\strip@PT\dim@x}%
  \dim@x=\cs@yd\unitlength \edef\ps@yd{\strip@PT\dim@x}%
  \dim@x=\csname node@#1@w\endcsname\unitlength \edef\ps@wa{\strip@PT\dim@x}%
  \dim@x=\csname node@#1@h\endcsname\unitlength \edef\ps@ha{\strip@PT\dim@x}%
  \dim@x=\csname node@#1@r\endcsname\unitlength \edef\ps@ra{\strip@PT\dim@x}%
  \dim@x=\csname node@#2@w\endcsname\unitlength \edef\ps@wd{\strip@PT\dim@x}%
  \dim@x=\csname node@#2@h\endcsname\unitlength \edef\ps@hd{\strip@PT\dim@x}%
  \dim@x=\csname node@#2@r\endcsname\unitlength \edef\ps@rd{\strip@PT\dim@x}%
  \put(0,0){\special{" \gas@initps
% Oval path around node A
    \ps@xa \ps@ya \ps@wa \ps@ha \ps@ra !psovalpath
    /path!a false upath cvlit def
% Oval path around node D
    \ps@xd \ps@yd \ps@wd \ps@hd \ps@rd !psovalpath
    /path!b false upath cvlit def
% The curve
	\gas@AHparam
	\ps@xa \ps@ya \ps@xb \ps@yb \ps@xc \ps@yc \ps@xd \ps@yd !ps_r_cbezier
  }}
% Coordinates (\cs@x,\cs@y) and slope (\cs@deltax,\cs@deltay) at the 
% point of the curve defined by the parameter label@pos.
  \def\@N{100}%
% coefficients of the polynomial x(t)
  \setcounter{cnt@a}{\cs@xd-\cs@xa+3*(\cs@xb-\cs@xc)}\edef\@A{\thecnt@a}%
  \setcounter{cnt@a}{3*(\cs@xa+\cs@xc-2*\cs@xb)}\edef\@B{\thecnt@a}%
  \setcounter{cnt@a}{3*(\cs@xb-\cs@xa)}\edef\@C{\thecnt@a}%
% computation of \cs@x and \cs@deltax
  \setcounter{cnt@a}{((\@A*\EL@p/\@N+\@B)*\EL@p/\@N+\@C)*\EL@p/\@N+\cs@xa}
  \edef\cs@x{\thecnt@a}%
  \setcounter{cnt@a}{(3*\@A*\EL@p/\@N+2*\@B)*\EL@p/\@N+\@C}
  \edef\cs@deltax{\thecnt@a}%
% coefficients of the polynomial y(t)
  \setcounter{cnt@a}{\cs@yd-\cs@ya+3*(\cs@yb-\cs@yc)}\edef\@A{\thecnt@a}%
  \setcounter{cnt@a}{3*(\cs@ya+\cs@yc-2*\cs@yb)}\edef\@B{\thecnt@a}%
  \setcounter{cnt@a}{3*(\cs@yb-\cs@ya)}\edef\@C{\thecnt@a}%
% computation of \cs@y and \cs@deltay
  \setcounter{cnt@a}{((\@A*\EL@p/\@N+\@B)*\EL@p/\@N+\@C)*\EL@p/\@N+\cs@ya}
  \edef\cs@y{\thecnt@a}%
  \setcounter{cnt@a}{(3*\@A*\EL@p/\@N+2*\@B)*\EL@p/\@N+\@C}
  \edef\cs@deltay{\thecnt@a}%
% Computation of sqrt(\cs@deltax^2+\cs@deltay^2).
  \setcounter{cnt@c}{\cs@deltax*\cs@deltax+\cs@deltay*\cs@deltay}
  \gas@sqrt{\thecnt@c}
  \ifnum\the@sqrt=0\def\the@sqrt{1}\fi
% Label of the edge.
% Computation of the shift from C to the center of the label.
  \setbox\temp@box\hbox{#3}
  \setcounter{cnt@a}{\wd\temp@box / \d@my@unit * \cs@deltay}
  \ifnum\thecnt@a<0 \setcounter{cnt@a}{-\thecnt@a} \fi
  \setcounter{cnt@c}{(\ht\temp@box+\dp\temp@box) / \d@my@unit * \cs@deltax}
  \ifnum\thecnt@c<0 \setcounter{cnt@c}{-\thecnt@c} \fi
  \setcounter{cnt@c}{(\thecnt@c+\thecnt@a) / \the@sqrt / 2 + \EL@dist}
  \if r\EL@s 
    \setcounter{cnt@a}{\cs@x+\cs@deltay * \thecnt@c / \the@sqrt}
    \setcounter{cnt@b}{\cs@y-\cs@deltax * \thecnt@c / \the@sqrt}
  \else
    \setcounter{cnt@a}{\cs@x-\cs@deltay * \thecnt@c / \the@sqrt}
    \setcounter{cnt@b}{\cs@y+\cs@deltax * \thecnt@c / \the@sqrt}
  \fi
% Shifting point C and drawing the label.
  \put(\thecnt@a,\thecnt@b){\makebox(0,0){#3}}
}}

%-----------------------------------------------------------------------
% Compute the lower interger part of the square root of 
% (the absolute value of) its argument.
% The result is obtained with \the@sqrt.
% We use Heron's method which converges quickly.
\newcounter{cnt@@a}\newcounter{cnt@@b}\newcounter{cnt@@c}
\def\gas@sqrt#1{%
  \ifnum#1<0\setcounter{cnt@@a}{-#1}\else\setcounter{cnt@@a}{#1}\fi
  \ifnum\thecnt@@a>1
    \setcounter{cnt@@b}{\thecnt@@a}
    \setcounter{cnt@@c}{(\thecnt@@a+1)/2}
	\@whilenum\thecnt@@b>\thecnt@@c\do{
      \setcounter{cnt@@b}{\thecnt@@c}
      \setcounter{cnt@@c}{(\thecnt@@b+\thecnt@@a/\thecnt@@b)/2}}
	\edef\the@sqrt{\thecnt@@b}
  \else
	\edef\the@sqrt{\thecnt@@a}
  \fi
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Compatibility with gastex v1.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Should be called inside the scope of a group
% 
%   {\compatiblegastexun ... }
% 
% The macros \drawloop and \drawedge are redefined to match the old 
% ones (v1.0) hence the new ones (v2.0) cannot be used inside the scope 
% of \compatiblegastexun.
%
% The compatibility is almost 100%: 
% - the following are ignored
%   \setmaxbezier
%   The optional argument of letstate defining the repeated state diameter
% - \settransdecal, \setedgedecal give curved edges
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\compatiblegastexun{
%-----------------------------------------------------------------------
% Definitions
%-----------------------------------------------------------------------
  \unitlength=4pt
  \d@my@unit= 2048sp % =1/32 pt ~= 0.011 mm
  \gasset{AHnb=1,AHangle=20}
  \def\AH@L{\strip@PT\@wholewidth 9 mul }
  \def\AH@l{\strip@PT\@wholewidth 9 mul 20 cos mul }
  \def\line@width{\strip@PT\@wholewidth}
%   
  \def\setstatediam##1{\gasset@Nw{##1}\gasset@Nh{##1}\gasset@Nmr{##1}}
  \def\setvertexdiam{\setstatediam}
  \setstatediam{6}
%   
  \def\setrepeatedstatediam##1{%
    \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{##1}}
    \edef\repeated@diam{\thecnt@a}}%
  \setrepeatedstatediam{5}
%   
  \def\setloopdiam{\gasset@loopdiam}%
  \setloopdiam{6}
%   
  \def\settranslabelskip{\gasset@ELdist}%
  \def\setedgelabelskip{\gasset@ELdist}
  \settranslabelskip{1}
%   
  \def\setprofcurve##1{%
    \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{##1}}
    \edef\prof@curve{\thecnt@a}}%
  \setprofcurve{3}
%   
  \def\settransdecal##1{%
    \setcounter{cnt@a}{1*\ratio{\unitlength}{\d@my@unit}*\real{##1}}
    \edef\trans@decal{\thecnt@a}}%
  \settransdecal{0}
  \def\setedgedecal{\settransdecal}
%   
  \def\setmaxbezier##1{}
  \def\setnbptbezier##1{} % compatibilité version 0.3
  \def\setprecision##1{} % compatibilité version 0.3
%   
  \def\setpsdash{\@ifnextchar[{\i@setpsdash}{\i@setpsdash[0]}}
  \def\i@setpsdash[##1](##2){%
	\dim@y=\unitlength \unitlength=1pt 
    \gasset@@dash{0 ##2}{##1}
	\unitlength=\dim@y
	\def\ps@dash{[##2] ##1\space}}%
  \setpsdash() % continuous path
%   
  \def\pcolor{}
  \def\pictcolor##1##2{}
%   
  \def\setpsgray##1{\gasset@linegray{##1}\gasset@fillgray{##1}}%
  \setpsgray{0} % black
%-----------------------------------------------------------------------
% States
%-----------------------------------------------------------------------
  \def\letstate{\@ifnextchar[{\i@letstate}{\ii@letstate}}%
  \def\i@letstate[##1,##2] ##3=(##4,##5){{%
    \gasset{Nw=##1,Nh=##1,Nmr=##1}
    \let@node(##3)(##4,##5){}}}
  \def\ii@letstate ##1=(##2,##3){%
    \let@node(##1)(##2,##3){}}
  \def\letvertex{\@ifnextchar[{\i@letvertex}{\ii@letstate}}%
  \def\i@letvertex[##1] ##2=(##3,##4){{%
    \gasset{Nw=##1,Nh=##1,Nmr=##1}
    \let@node(##2)(##3,##4){}}}
%   
  \def\drawstate(##1)##2{{\gasset{Nfill=n}\draw@node(##1){##2}}}%
  \def\drawvertex(##1)##2{{\gasset{Nfill=n,Nframe=n}\draw@node(##1){##2}}}%
  \def\drawcircledvertex{\drawstate}%
%   
  \def\drawinitialstate{%
    \@ifnextchar[{\@idrawinitialstate}{\@idrawinitialstate[l]}}
  \def\@idrawinitialstate[##1](##2)##3{{%
    \gasset{Nfill=n}\draw@node(##2){##3}
    \setcounter{cnt@a}{\N@w*\ratio{\d@my@unit}{\unitlength}/2}
    \if##1l \imark[iangle=180,ilength=\thecnt@a](##2) \fi
    \if##1r \imark[iangle=  0,ilength=\thecnt@a](##2) \fi
    \if##1t \imark[iangle= 90,ilength=\thecnt@a](##2) \fi
    \if##1b \imark[iangle=-90,ilength=\thecnt@a](##2) \fi}}
%   
  \def\drawfinalstate{%
    \@ifnextchar[{\@idrawfinalstate}{\@idrawfinalstate[r]}}
  \def\@idrawfinalstate[##1](##2)##3{{%
    \gasset{Nfill=n}\draw@node(##2){##3}
    \setcounter{cnt@a}{\N@w*\ratio{\d@my@unit}{\unitlength}/2}
    \if##1l \fmark[fangle=180,flength=\thecnt@a](##2) \fi
    \if##1r \fmark[fangle=  0,flength=\thecnt@a](##2) \fi
    \if##1t \fmark[fangle= 90,flength=\thecnt@a](##2) \fi
    \if##1b \fmark[fangle=-90,flength=\thecnt@a](##2) \fi}}
%   
  \def\drawrepeatedstate(##1)##2{{%
    \gasset{Nfill=n}\draw@node(##1){##2}
    \setcounter{cnt@a}{(\N@w-\repeated@diam)/2}
    \edef\rep@dist{\thecnt@a}%
    \rmark(##1)}}
%-----------------------------------------------------------------------
% Transitions
%-----------------------------------------------------------------------
  \let\gas@edge=\drawedge
  \def\drawtrans{\@ifnextchar[{\@idrawtrans}{\@idrawtrans[l]}}
  \def\@idrawtrans[##1](##2,##3)##4{%
    \setcounter{cnt@a}{\trans@decal*\ratio{\d@my@unit}{\unitlength}}
    \if##1r \gas@edge[ELside=r,curvedepth=\thecnt@a](##2,##3){##4} 
    \else \if##1b \gas@edge[ELside=r,curvedepth=\thecnt@a](##2,##3){##4} 
    \else \gas@edge[ELside=l,curvedepth=\thecnt@a](##2,##3){##4} \fi\fi}
  \def\drawedge{\drawtrans}
  \def\drawundirectededge##1(##2,##3)##4{%
    {\def\AH@nb{0 }\drawtrans##1(##2,##3){##4}}}
%   
  \def\drawcurvedtrans{%
    \@ifnextchar[{\@idrawcurvedtrans}{\@idrawcurvedtrans[l]}}
  \def\@idrawcurvedtrans[##1](##2,##3)##4{%
    \setcounter{cnt@a}{\prof@curve*\ratio{\d@my@unit}{\unitlength}}
    \if##1r \gas@edge[ELside=r,curvedepth=\thecnt@a](##2,##3){##4} 
    \else \if##1b \gas@edge[ELside=r,curvedepth=\thecnt@a](##2,##3){##4} 
    \else \gas@edge[ELside=l,curvedepth=\thecnt@a](##2,##3){##4} \fi\fi}
  \def\drawcurvededge{\drawcurvedtrans}
  \def\drawundirectedcurvededge##1(##2,##3)##4{%
    {\def\AH@nb{0 }\drawcurvedtrans##1(##2,##3){##4}}}
%   
  \def\drawqbeziertrans{%
    \@ifnextchar[{\@idrawqbeziertrans}{\@idrawqbeziertrans[l]}}
  \def\@idrawqbeziertrans[##1](##2)(##3,##4)(##5)##6{%
    \if##1r \drawqbedge[ELside=r](##2,##3,##4,##5){##6} 
    \else \if##1b \drawqbedge[ELside=r](##2,##3,##4,##5){##6}
    \else \drawqbedge[ELside=l](##2,##3,##4,##5){##6} \fi\fi}
  \def\drawqbezieredge{\drawqbeziertrans}
  \def\drawundirectedqbezieredge##1(##2)(##3,##4)(##5)##6{%
    {\def\AH@nb{0 }\drawqbeziertrans##1(##2)(##3,##4)(##5){##6}}}
%   
  \def\drawcbeziertrans{%
    \@ifnextchar[{\@idrawcbeziertrans}{\@idrawcbeziertrans[l]}}
  \def\@idrawcbeziertrans[##1](##2)(##3,##4)(##5,##6)(##7)##8{{%
    \if##1r \edef\EL@s{r} 
    \else \if##1b \edef\EL@s{r}
    \else \edef\EL@s{l} \fi\fi
	\draw@bcedge(##2,##3,##4,##7,##5,##6){##8}
  }}
  \def\drawcbezieredge{\drawcbeziertrans}
  \def\drawundirectedcbezieredge##1(##2)(##3,##4)(##5,##6)(##7)##8{%
    {\def\AH@nb{0 }\drawcbeziertrans##1(##2)(##3,##4)(##5,##6)(##7){##8}}}
%   
  \let\gas@loop=\drawloop
  \def\drawloop{\@ifnextchar[{\@idrawloop}{\@idrawloop[t]}}%
  \def\@idrawloop[##1](##2)##3{%
    \if##1l \gas@loop[loopangle=180](##2){##3} \fi
    \if##1r \gas@loop[loopangle=  0](##2){##3} \fi
    \if##1t \gas@loop[loopangle= 90](##2){##3} \fi
    \if##1b \gas@loop[loopangle=-90](##2){##3} \fi}
  \def\drawundirectedloop##1(##2)##3{%
    {\def\AH@nb{0 }\drawloop##1(##2){##3}}}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Compatibility with pspictpg v0.6
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Should be called inside the scope of a group
% 
%   {\compatiblepspictpg ... }
%   
% The macros \drawline and \drawcircle are redefined to match those of
% pspictpg hence thoses of GasTeX cannot be used inside the scope 
% of \compatiblepspictpg.
% 
% The following macros are ignored. Use linecolor and fillcolor instead.
% \pcolor, \pictcolor
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\compatiblepspictpg{
%   
  \def\setpsdash{\@ifnextchar[{\i@setpsdash}{\i@setpsdash[0]}}
  \def\i@setpsdash[##1](##2){%
	\dim@y=\unitlength \unitlength=1pt 
    \gasset@@dash{0 ##2}{##1}
	\unitlength=\dim@y
	\def\ps@dash{[##2] ##1\space}}%
  \setpsdash() % continuous path
%   
  \def\pcolor{}
  \def\pictcolor##1##2{}
%   
  \def\setpsgray##1{\gasset@linegray{##1}\gasset@fillgray{##1}}%
  \setpsgray{0} % black
% 
  % Redefinition of latex \line(a,b){L}.
  % Can be used with any values for a and b.
  \def\line(##1,##2)##3{{%
    \@xarg ##1\relax \@yarg ##2\relax
    \dim@x=##3\unitlength
    \special{" \gas@initps
      \the\@xarg\space \the\@yarg\space \strip@PT\dim@x !pslatexline}
  }}
% 
  % Redefinition of latex \vector(a,b){L}.
  % Can be used with any values for a and b.
  \def\vector(##1,##2)##3{{%
    \@xarg ##1\relax \@yarg ##2\relax
    \dim@x=##3\unitlength
    \special{" \gas@initps \gas@AHparam
      \the\@xarg\space \the\@yarg\space \strip@PT\dim@x !pslatexvector}
  }}
% 
  % redefinition of \circle of LaTeX 
  % can be used with any diameter
  \def\circle{\@ifnextchar*{\@idisk}{\@icircle}}
  \def\@icircle##1{{%
    \dim@x=##1\unitlength
    \special{" \gas@initps 
      \strip@PT\dim@x !pscircle}
  }}
  \def\@idisk*##1{{%
    \dim@x=##1\unitlength
    \special{" \gas@initps \fill@color 
      \strip@PT\dim@x !psdisk}
  }}
% 
  \def\drawline(##1,##2)(##3,##4){{%
    \gasset{AHnb=0}\draw@line(##1,##2,##3,##4)}}
  \def\drawvector(##1,##2)(##3,##4){{%
    \gasset{AHnb=1}\draw@line(##1,##2,##3,##4)}}
  \def\drawcircle(##1,##2)(##3){{%
    \gasset{Nframe=y,Nfill=n}\draw@circle(##1,##2,##3)}}
  \def\drawdisk(##1,##2)(##3){{%
    \gasset{Nframe=n,Nfill=y}\draw@circle(##1,##2,##3)}}
  \def\cbezier(##1,##2)(##3,##4)(##5,##6)(##7,##8){%
    \drawcbezier[AHnb=0](##1,##2,##3,##4,##5,##6,##7,##8)}
  \def\cbeziervector(##1,##2)(##3,##4)(##5,##6)(##7,##8){%
    \drawcbezier[AHnb=1](##1,##2,##3,##4,##5,##6,##7,##8)}
  \def\qbezier(##1,##2)(##3,##4)(##5,##6){%
    \drawqbezier[AHnb=0](##1,##2,##3,##4,##5,##6)}
  \def\qbeziervector(##1,##2)(##3,##4)(##5,##6){%
    \drawqbezier[AHnb=1](##1,##2,##3,##4,##5,##6)}
}

\endinput
